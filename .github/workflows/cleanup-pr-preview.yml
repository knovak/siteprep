name: Cleanup Branch Preview

on:
  delete:

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    # Only run for branch deletions, not tag deletions
    if: github.event.ref_type == 'branch'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if gh-pages branch exists
        id: check_branch
        run: |
          if git ls-remote --heads origin gh-pages | grep -q gh-pages; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "gh-pages branch does not exist yet, skipping cleanup"
          fi

      - name: Checkout gh-pages branch
        if: steps.check_branch.outputs.exists == 'true'
        run: |
          git checkout gh-pages

      - name: Configure Git
        if: steps.check_branch.outputs.exists == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Remove branch preview directory
        if: steps.check_branch.outputs.exists == 'true'
        run: |
          # Sanitize branch name (replace / with -)
          BRANCH_NAME="${{ github.event.ref }}"
          SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's/\//-/g')
          BRANCH_DIR="branch/$SAFE_BRANCH"

          if [ -d "$BRANCH_DIR" ]; then
            echo "Removing branch preview directory: $BRANCH_DIR"
            rm -rf "$BRANCH_DIR"

            # Regenerate index-versions.html
            cat > index-versions.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>SitePrep - All Versions</title>
            <link rel="stylesheet" href="./decks/india1/assets/styles.css">
          </head>
          <body>
            <header class="card">
              <div class="card-header">
                <p class="tag">Version Browser</p>
                <h1>SitePrep - All Versions</h1>
              </div>
              <div class="card-content">
                <p>Browse different versions of the site, including the main version and branch previews.</p>
              </div>
            </header>
            <main class="card">
              <div class="card-header">
                <h2>Main Version</h2>
              </div>
              <div class="card-content">
                <ul class="toc-grid">
                  <li class="toc-item">
                    <h3>main</h3>
                    <p>Latest production version from main branch</p>
                    <a href="./index.html">View main version</a>
                  </li>
                </ul>
              </div>
            </main>
          EOF

            # Add branch previews section if any remain
            if [ -d "branch" ]; then
              BRANCH_DIRS=$(find branch -maxdepth 1 -type d ! -name 'branch' -printf '%f\n' | sort)
              if [ -n "$BRANCH_DIRS" ]; then
                cat >> index-versions.html <<'EOF'
            <main class="card">
              <div class="card-header">
                <h2>Branch Previews</h2>
                <p class="meta">Preview builds from feature branches</p>
              </div>
              <div class="card-content">
                <ul class="toc-grid">
          EOF

                for dir in $BRANCH_DIRS; do
                  cat >> index-versions.html <<EOF
                  <li class="toc-item">
                    <h3>${dir}</h3>
                    <p>Preview from branch ${dir}</p>
                    <a href="./branch/${dir}/index.html">View ${dir}</a>
                  </li>
          EOF
                done

                cat >> index-versions.html <<'EOF'
                </ul>
              </div>
            </main>
          EOF
              fi
            fi

            cat >> index-versions.html <<'EOF'
          </body>
          </html>
          EOF

            # Commit and push
            git add -A
            if ! git diff --staged --quiet; then
              git commit -m "Remove branch $BRANCH_NAME preview"
              git push
              echo "Branch preview removed successfully"
            else
              echo "No changes to commit"
            fi
          else
            echo "Branch preview directory not found: $BRANCH_DIR"
          fi
